

## 分布式一致性协议、事务

CAP/BASE

CAP：一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）这三个基本需求，最多只能同时满足其中的2个。P：分布式系统中一些节点出现网络异常而不与整个集群网络联通就叫分区。

BASE：对CAP中强一致性和高可用性权衡的结果。其核心思想是即使无法做到强一致性，但每个应用都可以根据自身业务特点，才用适当的方式来使系统达到最终一致性。BASE是Basically Available(基本可用)，Soft State（软状态）和Eventually Consistent（最终一致性）三个短语的缩写。

基本可用：出现了不可预知的故障，但还是能用，只是比正常系统可能响应慢一点或者部分功能少有损失。软状态是指允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，允许初始状态到中间状态再到最终数据一致性的时间延迟。最终一致性是指软状态不可能一直是软状态，必须有个时间期限，在期限过后，应当保证所有副本保持数据一致性，从而达到数据的最终一致性。

2PC/3PC

2PC: 1.协议者向所有参与者发送vote request，参与者收到请求后，如果准备好了即回复协调者vote commit，未准备好事务则回复vote abort；2.协调者收到所有参与者的回复，如果全为vote commit，则发送global commit，否则发送global abort，参与者收到global commit则提交事务，否则取消事务。

2PC协议中，协调者等待所有参与者的表决都是同步阻塞的，在实际的应用中，这可能会导致长阻塞问题，这个问题是通过超时判断机制来解决的。但如果用了超时机制，如果出现协调者和参与者都挂了的情况，有可能导致数据不一致。

3PC：

1. CanCommit：协调者向参与者们发送 canCommit 请求，询问是否可以执行事务提交操作，参与者如果认为自己可以顺利提交事务则返回yes，否则返回no；

2. PreCommit：

    - 但凡有任一参与者向协调者发送的是no，或者在等待超时后协调者都没法收到所有参与者的反馈，那就直接中断事务，协调者向所有参与者发送abort请求，参与者则无论是收到abort还是等待超时，都执行事务中断。

    - 如果协调者收到回复都是yes，则进行preCommit：即向参与者发送preCommit 请求，并进入prepared阶段。参与者若收到precommit则执行事务操作，并将undo、redo信息记录到日志。如果各参与者都成功执行了事务操作，那么反馈给协调者 ACK 响应，同时等待最终指令：docommit / abort。

3. doCommit：

    - 但凡协调者收到任意一个no，或者超时等待后无法接收所有参与者的反馈，都会中断事务。此时，协调者向所有参与者节点发送 abort 请求，参与者接收到 abort 请求后，利用 undo 日志执行事务回滚，并在完成事务回滚后释放占用的资源，并向协调者Coordinator 发送 ack 信息，协调者接收到所有参与者反馈的 ack 信息后，中断事务。

    - 如果协调者收到所有参与者的 ack ，则从preCommit进入doCommit阶段，并向所有参与者发送doCommit请求，参与者收到 doCommit 请求后，正式提交事务，并在完成事务提交后向 协调者发送 ACK 信息，并释放占用的资源，协调者收到所有参与者的ack请求则完成事务。

3PC虽然解决了协调者与参与者都挂了的情况下数据不一致的问题，但带来了新的问题：比如网络分区问题，在 preCommit 消息发送后突然两个机房断开，这时候 Coordinator 所在机房会 abort, 另外剩余参与者的机房则会 commit。

拜占庭容错与非拜占庭容错

**Paxos**

<img src="assets/1640df969e7f7d16" alt="img" style="zoom: 40%;" />

在具体的实现中，一个进程即可能是Proposer,也可能是Acceptor，也可能是Learner.

![1567754046687](assets/1567754046687.png)

![1567753711951](assets/1567753711951.png)

![1567753770653](assets/1567753770653.png)

![1567754008592](assets/1567754008592.png)

Basic Paxos问题：难实现，有两轮rpc，效率低，且容易出现活锁。

![1567754282621](assets/1567754282621.png)

活锁解决办法，被抢的议员随机等待一段时间。

Multi Paxos：新概念 Leader：唯一的proposer，所有请求均需经过此leader

![1567755048004](assets/1567755048004.png)

![1567755281478](assets/1567755281478.png)

**Raft**

<img src="assets/1567755311407.png" alt="1567755311407" style="zoom: 33%;" />



https://blog.csdn.net/sunyurun/article/details/8297419

分布式系统三态：任何请求都要考虑三种情况：**成功、失败、超时**。对于超时的请求，无法获知该请求是否被成功执行。

副本一致性分类：

> 强一致性：任何时刻任何用户/节点都可以读到最近一次更新成功的副本数据
> 单调一致性：任何时刻任何用户一旦读到某个数据某次更新后的值，就不会再读到更旧的值
> 会话一致性：任何时刻任何用户在某次会话内一旦读到某个数据某次更新后的值，就不会在这次会话再读到更旧的值
> 最终一致性：各个副本的数据最终将达到一致状态，但时间不保证
> 弱一致性：没有实用价值，略。

### 数据分布方式

基本问题：如何拆分分布式系统的数据。

1.哈希方式：元信息少，散列性号，扩展性差，容易数据倾斜。

2.按数据范围分布：扩展性强，但是元数据需要记录所有的数据分布情况，消耗大，维护困难

3.按数据量分布：与按范围分布数据方式类似，元信息容易成为瓶颈，但不会数据倾斜

4.一致性哈希

> 以机器为节点：随机分布节点的方式使得很难均匀的分布哈希值域， 一个节点异常时压力全转移到相邻节点，随机分布节点容易造成不均匀
>
> 增设虚节点：虚节点，虚节点个数远大于机器个数，将虚节点均匀分布到值域环上，通过元数据找到真实机器节点。某一个节点不可用导致多个虚节点不可用，均衡了压力，同理加入新节点导致增加多个虚节点，缓解了全局压力。

但是以上没考虑数据副本的问题。

如果以机器为副本，恢复效率低，可扩展性差，可用性也差。

把数据和副本均分段，然后哈希到不同机器上去，可以利用整个集群分担节点失效同步压力，可用性也高，缺点是需要维护的元信息比较多。

另外为了提高性能，避免网络带宽成为瓶颈，提出了“本地化计算”，数据在哪里，计算就在哪个节点进行。

**GFS和HDFS选择了按数据量分布，Cassandra倒是选择了一致性哈希。**

### 基本副本协议

副本怎么确保一定的可用性和一致性？两大类：中心化副本协议和去中心化副本协议。去中心化副本控制协议没有中心节点，节点之间通过平等协商达到一致。工程中唯一能应用在强一致性要求下的是**paxos协议**。后续介绍。

中心化副本协议：由一个中心节点协调副本数据的更新、维护副本之间一致性，并发控制

常用模型：primary-secondary协议

更新：primary副本接受更新请求，决定更新操作先后顺序然后将更新操作发给secondary节点，primary根据secondary回复的情况决定此次更新是否成功。

读取：

方法一：由于数据更新流程都是由primary控制的，primary副本上数据一定最新。所以永远只读primary副本的数据能够实现强一致性。为了避免机器浪费，可以使用之前讨论的方法，将数据分段，将数据段作为副本单位。达到每台机器都有primary副本的目的。

方法二：由primary控制secondary的可用性。当primary更新某个secondary不成功时，将其标记为不可用。不可用的secondary副本继续尝试与primary同步数据，直到成功同步后转为可用状态。

方法三：Quorum机制。后续讨论。

如何确定节点状态以发现原primary节点出现异常(Lease机制)。切换primary后不能影响一致性(Quorum机制)。

当发生secondary与primary不一致的情况，需要secondary向primary进行同步(reconcile)。

不一致的原因有3种：

1. 网络分化等异常导致secondary落后于primary，常用的方式是回放primary上的操作日志(redo log)，追上primary的更新进度

2. 某些协议下secondary是脏数据，丢弃转到第三种情况；或者设计基于undo log的方式

3. secondary是一个新增副本完全没有数据，直接copy primary的数据，但要求同时primary能继续提供更新服务，这就要求primary副本支持快照(snapshot)功能。即对某一刻的副本数据形成快照，然后copy快照，再使用回放日志的方式追赶快照后的更新操作。

### Lease机制

### Quorum机制

### 日志技术

### 两阶段提交协议

### MVCC分布式事务

### CAP理论

### Paxos协议